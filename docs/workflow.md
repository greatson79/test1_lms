# Userflow

## 1. 역할 선택 & 온보딩

**입력**

* 이메일/비밀번호
* 역할 선택 (Learner / Instructor)
* 공통 프로필 최소 입력: 이름, 약관동의 (휴대폰번호는 선택 — 마이페이지에서 추후 등록)

**처리**

* Auth 계정 생성 (Supabase)
* 역할 저장 (`role=learner | instructor`)
* 프로필 레코드 생성
* 약관 이력 저장
* 기본 권한 토큰 발급

**출력**

* Learner → 코스 카탈로그 첫 진입
* Instructor → 대시보드 첫 진입

---

## 2. 코스 탐색 & 수강신청/취소 (Learner)

**입력**

* 검색어, 필터(카테고리, 난이도), 정렬(최신순/인기순)
* 코스 상세 진입
* “수강신청” / “수강취소” 버튼 클릭

**처리 (정책)**

* 코스 상태 `published`만 신청 가능
* `enrollments` 테이블 조회:
  * 기록 없음 → INSERT (신규 신청)
  * 기록 있음(`cancelled_at IS NOT NULL`) → UPDATE (`cancelled_at = NULL, enrolled_at = NOW()`) (재신청)
  * 기록 있음(`cancelled_at IS NULL`) → 에러 (이미 수강 중)
* **재수강 정책: 이어하기** — 재신청 시 기존 `submissions` 데이터를 유지. 과거 제출/채점 이력이 그대로 보존되며 학습을 이어서 진행함 (초기화 미지원)
* 수강취소 시 대시보드/내 코스에서 제거, 성적 집계 제외

**출력**

* 신청/취소 성공/실패 피드백
* Learner 대시보드 반영

---

## 3. Learner 대시보드

**입력**

* 대시보드 접근

**처리 (정책)**

* 내 코스 목록 표시
* 진행률 계산(완료 과제 수/전체 과제 수)
* 마감 임박 과제 표시
* 최근 피드백 요약 표시

**출력**

* 내 코스, 진행률, 마감 임박 과제, 최근 피드백

---

## 4. 과제 상세 열람 (Learner)

**입력**

* 내 코스 → Assignment 목록 → Assignment 상세 클릭

**처리 (정책)**

* Assignment 상태 `published`만 열람 가능
* `closed` 상태면 제출 버튼 비활성화
* 본인 코스 등록 여부 검증

**출력**

* 과제 설명, 마감일, 점수 비중, 정책(지각 허용 여부/재제출 허용 여부)
* 제출 UI(text+link 입력란)

---

## 5. 과제 제출/재제출 (Learner)

**입력**

* Text 필드 + Link 필드 (URL 형식) — **둘 중 하나 이상 입력 필수** (텍스트만, 링크만, 또는 둘 다 허용)
* 제출 버튼 클릭

**처리 (정책)**

* 마감일 전: 정상 제출 (`status=submitted`)
* 마감일 후:

  * `지각 허용 = true` → `status=submitted`, `late=true`
  * `지각 허용 = false` → 제출 차단
* 재제출 허용 여부 검증
* 유효성 검사: `content_text`, `content_link` 둘 다 비어 있으면 제출 차단

**출력**

* 제출 성공/실패 메시지
* Learner 화면에서 상태 업데이트

---

## 6. 성적 & 피드백 열람 (Learner)

**입력**

* 성적 페이지 접근

**처리 (정책)**

* 본인 제출물만 조회 가능
* 과제별 점수, 지각 여부, 재제출 여부, 피드백 표시
* 코스별 성적 계산 — **두 가지 지표를 함께 표시**
  * **현재 평점** (퀄리티 지표 — "제출한 것 중에서의 평균"):
    * 분자: SUM(score × weight) WHERE status = 'graded'
    * 분모: SUM(weight)         WHERE status = 'graded'
    * ※ 미제출/미채점 과제는 집계에서 제외
  * **예상 최종 성적** (달성도 지표 — "지금까지의 실제 성취"):
    * 분자: SUM(score × weight) WHERE status = 'graded'
    * 분모: SUM(weight)         WHERE course_id = ? (코스 전체 published 과제 비중 합산)
    * ※ 미제출 과제는 0점으로 반영

**출력**

* 과제별 점수/상태 (미채점 과제는 "-" 표시)
* 현재 평점 + 예상 최종 성적 함께 표시

---

## 7. Instructor 대시보드

**입력**

* 대시보드 접근

**처리 (정책)**

* 내 코스 목록 표시(draft/published/archived)
* 채점 대기 수 표시
* 최근 제출물 표시

**출력**

* 내 코스, 채점 대기, 최근 제출물

---

## 8. 코스 관리 (Instructor)

**입력**

* 코스 생성/수정 (제목, 소개, 카테고리, 난이도, 커리큘럼)
* 상태 전환(draft/published/archived)

**처리 (정책)**

* 소유자만 접근 가능
* `draft → published` 전환 시 공개
* `published → draft` 역방향 허용 — 수강생이 1명 이상 존재하면 경고 모달 노출 후 확인 시 전환
* `published → archived` 전환 시 신규 수강 차단

**출력**

* 생성/수정/상태 전환 결과 반영

---

## 9. 과제 관리 (Instructor)

**입력**

* 과제 생성/수정 (제목, 설명, 마감일, 점수 비중, 지각/재제출 정책)
* 상태 전환(draft/published/closed)

**처리 (정책)**

* 소유 코스만 접근 가능
* 게시 시 학습자 노출
* 마감일 이후 자동 `closed`
* 제출물 테이블: 필터(미채점/지각/재제출요청)

**출력**

* Assignment 목록 갱신
* Learner 화면 반영

---

## 10. 제출물 채점 & 피드백 (Instructor)

**입력**

* 제출물 선택
* 점수(0~100), 피드백 작성
* “재제출 요청” 버튼 선택 가능

**처리 (정책)**

* 점수 범위 제한
* 피드백 필수
* 점수 입력 → `graded`
* 재제출 요청 → `resubmission_required`

**출력**

* Learner에게 피드백 표시
* Learner 대시보드 과제 상태 반영

---

## 11. Assignment 게시/마감 (Instructor)

**입력**

* 과제 게시/마감

**처리 (정책)**

* `draft → published` 전환 시 학습자 노출
* 유효 상태(Effective Status) 판별:
  * DB `status = 'closed'` → 마감 (강사 수동 강제 마감)
  * DB `status = 'published'` AND `NOW() > due_at` → 마감 (자동 마감)
  * 그 외 → 진행 중
* 마감 후 제출 불가, 채점만 가능

**출력**

* Assignment 상태 갱신
* Learner 화면 반영

---

## 12. 운영 (Operator)

**입력**

* 신고 접수(코스/과제/제출물/사용자, 사유, 내용) — 로그인 유저 누구나 가능

**처리 (정책)**

* 신고 접수 → `reports` 테이블 INSERT (`status = 'received'`)
* **프론트엔드 어드민 UI 미구현 (MVP 범위 외)** — 신고 접수 시 운영자에게 이메일/Slack 알림 발송
* 신고 처리(상태 변경, 액션)는 운영자가 DB 직접 쿼리로 수행
* **메타데이터(카테고리/난이도) 관리 UI 미구현** — Seed 데이터로 초기 고정값 제공, 변경 필요 시 마이그레이션 파일 추가

**출력**

* 신고 접수 확인 토스트 메시지
* 운영자 알림 발송 (이메일/Slack)
